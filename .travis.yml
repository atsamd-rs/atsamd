language: rust

cache: cargo

rust:
  - stable
  - nightly

env:
  - BOARD=metro_m0 EXAMPLES="--example=blinky_basic --example=blinky_rtfm"
  - BOARD=metro_m4 FEATURES="--features=unproven"
  - BOARD=feather_m0 FEATURES="--features=unproven"
  - BOARD=feather_m4
  - BOARD=gemma_m0
  - BOARD=itsybitsy_m0
  - BOARD=trinket_m0
  - BOARD=samd21_mini
  - BOARD=arduino_mkrzero
  - BOARD=circuit_playground_express
  - BOARD=sodaq_one
  - BOARD=pyportal
  - BOARD=trellis_m4 FEATURES="--features=keypad-unproven"

matrix:
  allow_failures:
    rust:
      - nightly

before_install:
  - rustup target add thumbv6m-none-eabi
  - rustup target add thumbv7em-none-eabihf

script:
  - "cd boards/$BOARD"
  - "cargo build ${EXAMPLES:---examples} $FEATURES"

jobs:
  include:
    - stage: Document-and-Deploy
      rust: 'nightly'
      env: ''
      script:
        - ./build-docs.py
      deploy:
        provider: pages
        skip-cleanup: true
        github-token: $GITHUB_TOKEN
        keep-history: false
        local-dir: doc

stages:
  - test
  - name: Document-and-Deploy
    if: (NOT type IN (pull_request)) AND (branch = master)
